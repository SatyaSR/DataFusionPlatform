<!DOCTYPE html>
<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
<script>
$(document).ready(function(){
    $("p").click(function(){
        $(this).hide();
    });
});
</script>
</head>
<body>

<div id="console">
<button type="button">Find available data</button>
<button id="findRep" onclick="findRep()" type="button">Find all matches</button>
<button id="repMatch" onclick="findRepresents()" type="button">Suggest match</button>
<button type="button">Suggest intermediate</button>
<div id="metainfo"></div>
</div>


<div id="graph">
</div>



<style type="text/css">
    .node { stroke: #222; stroke-width: 1.5px; }
    .node.Column { fill: #777; }
    .node.Table { fill: #BBB; }
    .node.JoinTable { fill: #999}
    .node.Dataset { fill: #333}
    .link { stroke: #999; stroke-width: 7px; }
    div {height: 100%;}
    html {height: 100%;}
    body {height: 100%;}
</style>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script type="text/javascript">
    var width = 1200, height = 800, radius = 20;

    var force = d3.layout.force()
            .charge(-1000).linkDistance(150).size([width, height]);

    var svg = d3.select("#graph").append("svg")
            .attr("width", "100%").attr("height", "100%")
            .attr("pointer-events", "all");
 
	var currRepresents = "null";
    
 	
    d3.json("/Justin/graph", function(error, graph) {
		if (error) return;
		
        force.nodes(graph.nodes).links(graph.links).start();

        var link = svg.selectAll(".link")
                .data(graph.links).enter()
                .append("line").attr("class", "link");

        var node = svg.selectAll(".node")
                .data(graph.nodes).enter()
                .append("circle")
                .attr("class", function (d) { console.log("Represents: " + d.properties.represents); return "node "+ d.type.toString() })
                .attr("r", radius)
                .style("fill", function(d) {return d.colr; })
                .call(force.drag);

        // html title attribute
        node.append("title")
                .text(function (d) { return d.name; })
                
                
		var state = false;
        var last = null;
        var current = null;
 		node.on("click", function(n)
        		{
        			//Return color of nodes back to normal
        			svg.selectAll(".node").style("fill", function(d) { return d.colr; });
        			
					//d3.json("/node_info", function(error, nodeInfo){if(error) return;})
					var metainf = "";
					
					//Get Represents property from currently selected node
					currRepresents = n.properties.represents;
					
					metainf = metainf.concat("Title: ", n.name, "<br/>Label: ", n.type, "<br/>Represents: ", currRepresents);
					console.log(metainf);
					d3.select("#metainfo")
						.html(metainf);
					
					last = current;
					current = d3.select(this);
				    current.style('fill', 'red');
				    last.style('fill', function(d) { return d.colr; });
				

				    
        		});



        // force feed algo ticks
        force.on("tick", function() {
        	
        	 node.attr("cx", function(d) { return d.x = Math.max(radius, Math.min(width - radius, d.x)); })
             .attr("cy", function(d) { return d.y = Math.max(radius, Math.min(height - radius, d.y)); });
        	
        	
            link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

            node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
        });
        
        
        
    });
    
    function findRepresents() {
    	if (currRepresents == "null") {
    		console.log("No node is clicked on currently!");
    	} else {
        	console.log(currRepresents);
    	}
    	
    }
    function findRep() {
				    
		//Dont highlight all the nodes with no represents value
	   	if (currRepresents !== undefined) {
	    	console.log("Get rep is " + getRep);
				    	
			//Filter through all nodes to find matches, and color them blue
			svg.selectAll(".node")
			.filter(function(d) { return d.properties.represents == getRep; })
			.style('fill', 'blue');
		}
	}
    

</script>
</body>
</html>
